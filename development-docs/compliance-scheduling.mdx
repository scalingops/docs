---
title: Compliance Scheduling
description: Automate compliance runs with scheduled templates
---

# Compliance Scheduling

The Compliance Scheduling feature allows you to automate compliance runs based on predefined templates and schedules. This ensures regular compliance checks without manual intervention.

## Overview

Compliance scheduling combines run templates with cron-based scheduling to automatically execute compliance checks at specified intervals. When a schedule triggers, it creates compliance runs and assignments based on the template configuration.

## Accessing Compliance Scheduling

Navigate to **Settings → Compliance → Schedule** in the application. This page provides a comprehensive view of all your scheduled compliance runs.

## Key Components

### 1. Compliance Run Templates

Templates define what checks, groups, and entities (companies, locations, devices) should be included in a compliance run. Templates are created and managed in **Settings → Compliance → Runs**.

### 2. Schedules

Schedules determine when templates should be executed. Each schedule includes:
- **Name**: Descriptive name for the schedule
- **Description**: Optional details about the schedule's purpose
- **Template**: The compliance run template to execute
- **Frequency**: Cron expression defining when to run
- **Timezone**: Timezone for schedule execution
- **Active Status**: Whether the schedule is currently active

### 3. Edge Function

An edge function (`process-scheduled-compliance-runs`) runs periodically to:
1. Check for schedules where `next_run` has passed
2. Create compliance runs based on the template configuration
3. Generate assignments for all specified checks and entities
4. Update `last_run` and calculate the next `next_run` time

## Creating a Schedule

1. Click the **Create Schedule** button
2. Fill in the schedule details:
   - **Schedule Name**: e.g., "Weekly Security Audit"
   - **Description**: Optional context about the schedule
   - **Run Template**: Select from available templates
   - **Frequency**: Choose a predefined option or use custom cron
   - **Timezone**: Select the appropriate timezone

3. Click **Create Schedule** to save

## Schedule Frequencies

The system supports common scheduling patterns:

- **Daily at midnight**: Runs every day at 12:00 AM
- **Weekly on Monday**: Runs every Monday at midnight
- **Monthly on the 1st**: Runs on the first day of each month
- **Every 6 hours**: Runs four times daily
- **Weekdays at 9 AM**: Runs Monday-Friday at 9:00 AM

### Custom Cron Expressions

For advanced scheduling needs, you can use custom cron expressions:

```
┌───────────── minute (0 - 59)
│ ┌───────────── hour (0 - 23)
│ │ ┌───────────── day of month (1 - 31)
│ │ │ ┌───────────── month (1 - 12)
│ │ │ │ ┌───────────── day of week (0 - 6)
│ │ │ │ │
* * * * *
```

Examples:
- `0 2 * * *` - Daily at 2:00 AM
- `30 14 * * 1-5` - Weekdays at 2:30 PM
- `0 0 15,30 * *` - 15th and 30th of each month

## Managing Schedules

### Activating/Pausing Schedules

Use the toggle switch in the Status column to activate or pause a schedule. Paused schedules won't create new compliance runs.

### Editing Schedules

1. Click the **Edit** button next to a schedule
2. Modify the schedule details
3. Click **Update Schedule** to save changes

### Deleting Schedules

1. Click the **Delete** button next to a schedule
2. Confirm the deletion in the dialog
3. The schedule will be permanently removed

## Schedule Execution Process

When a schedule is triggered:

1. **Template Retrieval**: The system fetches the associated template configuration
2. **Entity Resolution**: Determines which companies, locations, and devices are included
3. **Run Creation**: Creates compliance run records for each company
4. **Check Assignment**: Assigns all checks from the template to the appropriate entities
5. **Timestamp Update**: Updates `last_run` and calculates `next_run` based on the cron expression

## Database Schema

### compliance_run_schedules Table

```sql
CREATE TABLE compliance_run_schedules (
  id UUID PRIMARY KEY,
  tenant_id UUID NOT NULL,
  template_id UUID NOT NULL,
  name VARCHAR(255) NOT NULL,
  description TEXT,
  cron_expression VARCHAR(255) NOT NULL,
  timezone VARCHAR(100) DEFAULT 'UTC',
  active BOOLEAN DEFAULT true,
  last_run TIMESTAMPTZ,
  next_run TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### Key Relationships

- `template_id` → References `compliance_runs_templates.id`
- `tenant_id` → References `tenants.id` for multi-tenancy

## API Endpoints

### GET /api/compliance-schedules
Retrieves all schedules for the current tenant.

### POST /api/compliance-schedules
Creates a new schedule.

**Request Body:**
```json
{
  "name": "Weekly Audit",
  "description": "Weekly security compliance audit",
  "template_id": "uuid",
  "cron_expression": "0 0 * * 1",
  "timezone": "UTC",
  "active": true
}
```

### PUT /api/compliance-schedules/[id]
Updates an existing schedule.

### DELETE /api/compliance-schedules/[id]
Deletes a schedule.

## Edge Function Details

The `process-scheduled-compliance-runs` edge function:

1. **Trigger**: Can be invoked manually or via cron job
2. **Process**:
   - Queries active schedules where `next_run ≤ NOW()`
   - For each schedule:
     - Creates compliance runs based on template
     - Assigns checks to entities
     - Updates schedule timestamps
3. **Error Handling**: Logs errors for individual schedules without stopping the entire process
4. **Response**: Returns summary of processed schedules and any errors

### Invoking the Edge Function

The edge function can be triggered via:
- Supabase Dashboard cron jobs
- External schedulers
- Manual invocation for testing

## Monitoring and Troubleshooting

### View Schedule Status

The Schedule page displays:
- **Next Run**: When the schedule will execute next
- **Last Run**: When it last executed
- **Status**: Active or Paused state

### Common Issues

1. **Schedule Not Running**
   - Verify the schedule is active
   - Check that the template exists and is valid
   - Ensure the edge function is deployed and running

2. **Missing Assignments**
   - Confirm the template has checks/groups assigned
   - Verify entities (companies/locations/devices) exist

3. **Incorrect Timing**
   - Review the cron expression
   - Check the timezone setting
   - Verify the edge function execution frequency

## Best Practices

1. **Template Design**: Create focused templates for specific compliance areas
2. **Scheduling**: Avoid overlapping schedules that might create duplicate work
3. **Timezone Awareness**: Set schedules in the appropriate timezone for your operations
4. **Regular Review**: Periodically review and update schedules as compliance needs change
5. **Testing**: Test schedules with a short interval initially to verify correct operation

## Security Considerations

- Schedules respect tenant isolation - each tenant can only see and manage their own schedules
- The edge function uses service role authentication to create runs on behalf of tenants
- All created runs and assignments maintain proper tenant_id references

## Future Enhancements

Planned improvements include:
- Email notifications when schedules run
- Schedule execution history and logs
- Advanced recurrence patterns
- Schedule dependencies and chaining
- Automated remediation workflows