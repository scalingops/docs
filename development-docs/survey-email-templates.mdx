---
title: "Survey Email Templates"
description: "Comprehensive documentation for the survey email template system including WYSIWYG editor, template variables, and customization options"
icon: "envelope"
---

## Overview

The Survey Email Templates system allows users to create and manage custom email templates for survey invitations using a rich WYSIWYG editor. The system supports template variables for dynamic content personalization and provides a complete template management interface.

## Architecture

### Database Schema

The system uses the `email_templates` table with the following structure:

```sql
CREATE TABLE email_templates (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    subject TEXT NOT NULL,
    html_body TEXT NOT NULL,
    text_body TEXT,
    variables TEXT[] DEFAULT '{}',
    is_default BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### Key Features
- **Tenant Isolation**: All templates are scoped to specific tenants via RLS policies
- **Default Template**: Only one template per tenant can be marked as default
- **Variable Extraction**: Automatically extracts and stores template variables
- **Dual Format**: Supports both HTML and plain text versions

## Components

### Main Components

#### EmailTemplateDialog
**Location**: `/components/surveys/settings/EmailTemplateDialog.tsx`

The primary dialog component for creating and editing email templates.

**Key Features:**
- WYSIWYG editor using `@tiptap` (project standard)
- Variable insertion panel
- Form validation
- Keyboard shortcuts support
- HTML and plain text editing

**Props:**
```typescript
interface EmailTemplateDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  mode?: "create" | "edit";
  template?: EmailTemplate;
  onSave: (template: Partial<EmailTemplate>) => Promise<void>;
}
```

#### SurveySettingsPage Integration
**Location**: `/components/surveys/settings/SurveySettingsPage.tsx`

Integrated into the Survey Settings page as the "Email Templates" tab.

**Features:**
- Template listing with metadata
- CRUD operations (Create, Read, Update, Delete)
- Template duplication
- Loading states
- Empty state handling

## Template Variables

### Available Variables

The system provides a comprehensive set of template variables for dynamic email content in the context of a **Managed Service Provider (MSP)** sending surveys to their clients:

```typescript
const AVAILABLE_VARIABLES = [
  { key: "{{recipient_name}}", description: "Recipient's name" },
  { key: "{{company_name}}", description: "Client company name (being surveyed)" },
  { key: "{{survey_title}}", description: "Survey title" },
  { key: "{{survey_url}}", description: "Survey link URL" },
  { key: "{{sender_name}}", description: "Sender's name" },
  { key: "{{sender_company}}", description: "MSP company name (sending the survey)" },
  { key: "{{expires_date}}", description: "Survey expiration date" },
];
```

### Variable Usage

#### In Templates
Variables can be inserted in both subject lines and email content:

```html
<!-- Subject: -->
Your feedback request from {{sender_company}}

<!-- Email body: -->
<p>Hi {{recipient_name}},</p>
<p>We'd love to hear about your experience with {{company_name}}.</p>
<p>As your managed service provider, {{sender_company}} values your feedback.</p>
<a href="{{survey_url}}">Take Survey</a>
<p>— The {{sender_company}} Team</p>
```

### MSP Context Explanation

In a **Managed Service Provider** environment, there are two distinct companies involved in survey communications:

| Variable | Represents | Example |
|----------|------------|---------|
| `{{company_name}}` | **Client Company** (being surveyed) | "ACME Corp", "Smith Industries" |
| `{{sender_company}}` | **MSP Company** (sending the survey) | "TechSupport Plus", "IT Solutions Inc." |

**Typical Use Case:**
- MSP "TechSupport Plus" provides IT services to client "ACME Corp"
- TechSupport Plus sends an NPS survey to ACME Corp employees
- Email references both companies appropriately:
  - "How was your experience with **ACME Corp**'s IT services?"
  - "This survey is from **TechSupport Plus**, your IT service provider"

#### Variable Extraction
The system automatically extracts variables from template content:

```typescript
const extractVariables = (content: string): string[] => {
  const matches = content.match(/\{\{[^}]+\}\}/g);
  return matches ? [...new Set(matches)] : [];
};
```

### Variable Substitution
During email sending, variables are replaced with actual values:

```typescript
// Example variable replacement
const personalizedContent = template.html_body
  .replace(/\{\{recipient_name\}\}/g, user.full_name)
  .replace(/\{\{company_name\}\}/g, company.name)
  .replace(/\{\{survey_url\}\}/g, `${baseUrl}/survey/${inviteToken}`);
```

## Server Actions

### Core Actions

Located in `/app/actions/emailTemplates.ts`:

#### `getEmailTemplates()`
Fetches all email templates for the current tenant.

```typescript
export async function getEmailTemplates() {
  // Returns { data: EmailTemplate[] } or { error: string }
}
```

#### `createEmailTemplate(templateData)`
Creates a new email template.

```typescript
export async function createEmailTemplate(
  templateData: Omit<EmailTemplate, "id" | "created_at" | "updated_at" | "tenant_id">
) {
  // Handles default template logic
  // Returns { data: EmailTemplate } or { error: string }
}
```

#### `updateEmailTemplate(id, templateData)`
Updates an existing email template.

```typescript
export async function updateEmailTemplate(
  id: string, 
  templateData: Partial<Omit<EmailTemplate, "id" | "created_at" | "tenant_id">>
) {
  // Handles default template transitions
  // Returns { data: EmailTemplate } or { error: string }
}
```

#### `deleteEmailTemplate(id)`
Deletes an email template.

```typescript
export async function deleteEmailTemplate(id: string) {
  // Returns { success: true } or { error: string }
}
```

#### `duplicateEmailTemplate(id)`
Creates a copy of an existing template.

```typescript
export async function duplicateEmailTemplate(id: string) {
  // Creates copy with modified name
  // Never duplicates as default
  // Returns { data: EmailTemplate } or { error: string }
}
```

## Default Template

### System Behavior
- Only one template per tenant can be marked as default
- When setting a template as default, other defaults are automatically unset
- Database constraint ensures uniqueness: `UNIQUE NULLS NOT DISTINCT (tenant_id, is_default)`

### Default Template Content
The system provides a professional default template:

```html
<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #ffffff;">
  <div style="text-align: center; margin-bottom: 30px;">
    <h1 style="color: #333; margin-bottom: 10px;">Your Feedback Matters</h1>
    <p style="color: #666; font-size: 16px;">Help us improve by sharing your experience</p>
  </div>
  
  <div style="background-color: #f9f9f9; padding: 25px; border-radius: 8px; margin-bottom: 25px;">
    <p style="color: #333; font-size: 16px; margin-bottom: 15px;">Hi {{recipient_name}},</p>
    
    <p style="color: #555; font-size: 14px; line-height: 1.5; margin-bottom: 20px;">
      We'd love to hear about your experience with {{company_name}}. Your feedback helps us improve our services.
    </p>
    
    <div style="text-align: center; margin: 30px 0;">
      <a href="{{survey_url}}" style="background-color: #007bff; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; font-weight: bold; display: inline-block;">
        Take Survey
      </a>
    </div>
    
    <p style="color: #666; font-size: 12px; text-align: center;">
      This survey will only take 2-3 minutes to complete
    </p>
  </div>
  
  <div style="text-align: center; color: #888; font-size: 12px; margin-top: 20px;">
    <p>Thank you for your time!</p>
    <p>— The {{sender_company}} Team</p>
  </div>
</div>
```

## User Interface

### Template Management Interface

#### Template List View
- **Grid Layout**: Templates displayed in cards with metadata
- **Template Information**: Name, subject, variable count, default status
- **Actions**: Edit, Preview, Duplicate, Delete dropdown menu

#### Template Creation/Editing
- **Modal Dialog**: Large modal with sidebar layout
- **Form Fields**: Name, subject line, default toggle
- **WYSIWYG Editor**: Rich text editor for HTML content
- **Variable Panel**: Right sidebar with clickable variables
- **Plain Text**: Optional fallback version

### Variable Insertion
**Interactive Panel**: Variables displayed as clickable badges
- Click to insert into active field
- Automatic detection of active field (subject, HTML, text)
- Visual feedback and descriptions

### Loading States
- **Template List**: Spinner during fetch
- **Form Submission**: Loading states during save/update operations
- **Error Handling**: Toast notifications for errors

## Usage Examples

### Basic Template Creation
```typescript
// Creating a simple template
const newTemplate = {
  name: "Welcome Survey",
  subject: "Welcome to {{company_name}} - Quick Survey",
  html_body: `
    <p>Hi {{recipient_name}},</p>
    <p>Welcome! Please take our quick survey:</p>
    <a href="{{survey_url}}">Start Survey</a>
  `,
  is_default: false
};

await createEmailTemplate(newTemplate);
```

### Template with Variables
```typescript
// Template using multiple variables
const template = {
  name: "Follow-up Survey",
  subject: "How was your experience with {{company_name}}?",
  html_body: `
    <p>Dear {{recipient_name}},</p>
    <p>Thank you for choosing {{company_name}}. We'd love to hear about your experience.</p>
    <p><strong>Survey: {{survey_title}}</strong></p>
    <a href="{{survey_url}}">Share Your Feedback</a>
    <p><small>This survey expires on {{expires_date}}</small></p>
    <p>Best regards,<br>{{sender_name}}<br>{{sender_company}}</p>
  `,
  text_body: `
    Dear {{recipient_name}},
    
    Thank you for choosing {{company_name}}. Please share your feedback:
    {{survey_url}}
    
    Survey: {{survey_title}}
    Expires: {{expires_date}}
    
    Best regards,
    {{sender_name}}
    {{sender_company}}
  `,
  is_default: true
};
```

## Security & Performance

### Row Level Security (RLS)
All database operations use RLS policies to ensure tenant isolation:

```sql
-- Example policy
CREATE POLICY "Users can view their tenant's email templates"
ON email_templates FOR SELECT
USING (tenant_id = (auth.jwt() ->> 'tenant_id')::UUID);
```

### Performance Optimizations
- **Indexed Queries**: Tenant ID and default status indexes
- **Lazy Loading**: Templates loaded only when tab is active
- **Automatic Updates**: Updated_at timestamp with triggers

### Input Validation
- **Template Names**: Required, non-empty strings
- **Subject Lines**: Required for email functionality
- **HTML Content**: Required, validated for structure
- **Variable Extraction**: Automatic parsing and validation

## Integration Points

### Survey System Integration
Templates are used when sending survey invitations:

```typescript
// Example integration with survey sending
const defaultTemplate = await getDefaultEmailTemplate(tenantId);
const personalizedEmail = await renderTemplate(defaultTemplate, {
  recipient_name: user.full_name,
  company_name: company.name,
  survey_url: inviteUrl,
  // ... other variables
});
```

### Settings Integration
- **Navigation**: Accessible via Surveys → Settings → Email Templates
- **Permissions**: Follows tenant-based access control
- **State Management**: Integrated with survey settings state

## Future Enhancements

### Planned Features
- **Template Preview**: Full email preview functionality
- **Template Import/Export**: Backup and sharing capabilities
- **A/B Testing**: Multiple template variations
- **Template Analytics**: Open rates and click tracking
- **Advanced Variables**: Conditional content and loops

### Technical Improvements
- **Template Validation**: Enhanced HTML validation
- **Mobile Preview**: Responsive design testing
- **Template Versioning**: Change history and rollback
- **Batch Operations**: Bulk template management

## Troubleshooting

### Common Issues

#### Templates Not Loading
- Check tenant context in server actions
- Verify RLS policies are correctly applied
- Ensure proper error handling in UI components

#### Variable Insertion Not Working
- Verify active field detection logic
- Check variable format consistency
- Ensure proper state updates

#### Default Template Conflicts
- Database constraint prevents multiple defaults
- Check update logic for default transitions
- Verify UI reflects current default state

### Debug Information
- Server actions log errors to console
- UI components handle loading states
- Database queries use proper tenant filtering